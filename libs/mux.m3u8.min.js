(t=>{const n={stretchShortVideoTrack:!1,maxBufferHole:.5,maxAudioFramesDrift:1,enableSoftwareAES:!0,forceKeyFrameOnDiscontinuity:!0},h={mp4:MediaSource.isTypeSupported("video/mp4"),mpeg:MediaSource.isTypeSupported("audio/mpeg"),mp3:MediaSource.isTypeSupported('audio/mp4; codecs="mp3"')};let d=null;class s{constructor(t,e,s,r){this.demuxer=null,this.remuxer=null,this.initSegment=t,this.audioCodec=e,this.videoCodec=s,this.duration=r,this.result={},this.resolve=null,this.reject=null,this._evt_=[]}init(){this.demuxer&&(this.demuxer.resetInitSegment(this.initSegment,this.audioCodec,this.videoCodec,this.duration),this.demuxer.resetTimeStamp()),this.remuxer&&(this.remuxer.resetInitSegment(),this.remuxer.resetTimeStamp())}get observer(){return{trigger:(t,e)=>{if(this._evt_.push(t.replace(/hlsFrag/,"").replace(/hls/,"")),"hlsError"===t&&this.reject({fatal:!1,message:e}),t===HlsEvents.FRAG_PARSED)return this._evt_=[],this.resolve(this.result);t===HlsEvents.FRAG_PARSING_INIT_SEGMENT?this.result[t]=e:t===HlsEvents.FRAG_PARSING_DATA&&(this.result[t]||(this.result[t]=[]),this.result[t].push(e))}}}parse(r,t,i,a,o){return new Promise(async(t,e)=>{this.result={},this.resolve=t,this.reject=e;try{if(r=new Uint8Array(r),!this.demuxer){for(const s of HlsMux)if(s.demux.probe(r)){this.remuxer=new s.remux(this.observer,n,h,navigator.vendor),this.demuxer=new s.demux(this.observer,this.remuxer,n,h);break}if(!this.demuxer)return e({fatal:!0,message:"No usable media demuxer"});o=!1}o||this.init(),c()||this.demuxer.append(r,i,o,a)}catch(t){e({fatal:!0,message:t.message})}})}}class l{constructor(t){var e=t.master[t.index];this.name=t.name,this.tracksIndex={},this.tracks=[],this.sourceType=2,this.hasAltAudio=!1,this.isLive=void 0!==e.details.live&&e.details.live,this.size=0,this.blobURL=null,this.preview=null,this.quality=null,this.dataPushConfig={prevSN:-1,prevCC:-1,prevError:null},this.demuxer=new s(e.details.initSegment.data||[],e.audioCodec,e.videoCodec,e.details.totalduration),this._parent=t,this.step=0}async flush(){var t=this._parent.master[this._parent.index];!t||(t=t.details.fragments)&&this.step<this._parent.total&&("completed"===(t=t[this.step]).status&&t.data&&(this.step++,this.push(t)))}async push(e){if(e.data&&"completed"===e.status&&"cancel"!==this._parent.status&&"error"!==this._parent.status){let t=isNaN(e.startDTS)?e.start:e.startDTS;c()&&(t*=2);try{var s,r=e.sn===this.dataPushConfig.prevSN+1&&e.cc===this.dataPushConfig.prevCC&&!this.dataPushConfig.prevError,i=(this.dataPushConfig.prevError=null,this.dataPushConfig.prevSN=e.sn,this.dataPushConfig.prevCC=e.cc,e.data),a=(e.data=null,await this.demuxer.parse(i,e.decryptdata,t,!0,r)),o=a[HlsEvents.FRAG_PARSING_INIT_SEGMENT],n=(o&&m(this,0,o),a[HlsEvents.FRAG_PARSING_DATA]);if(n)for(const h of n)f(this,e,h);this._parent.hasQuality||!this.quality||this._parent.isMaster||(this._parent.downloadUI.loadIndexSuccess(null,this.quality,!1),this._parent.hasQuality=!0),this.preview||"normal"===this._parent.status&&4194304<this._parent.size&&((s=await g(this))||(this._parent.status="error",this._parent.downloadUI.error("500: Video flush error")),this.preview=s,this._parent.downloadUI.setPreview(s))}catch(t){t.fatal&&(e.status="error",this._parent.status="error",this._parent.downloadUI.error("501: Data parse error")),this.prevError=t}}}getTrackByType(t){return void 0===this.tracksIndex[t]&&(this.tracksIndex[t]=this.tracks.length,this.tracks.push({init:null,moofs:[],mdats:[],start:[],durations:[],duration:0,mimetype:t,quality:""})),this.tracks[this.tracksIndex[t]]}getTrackByNumber(t){for(const e of this.tracks)if(e.init?.root?.moov?.trak?.tkhd?.trackID===t)return e;return null}revokeURL(){this.blobURL&&(URL.revokeObjectURL(this.blobURL),this.blobURL=null)}setQuality(){let t="",e="";for(const s of this.tracks)s?.mimetype?.includes("video")&&(t=s.quality),s?.mimetype?.includes("audio")&&(e=s.quality);this.quality=t+(""!==t?" - ":"")+e}getQuality(){return this.quality||this.setQuality(),this.quality}clearAllTracks(){this.dataPushConfig.prevSN=-1,this.dataPushConfig.prevCC=-1;for(const t of this.tracks)this.clearTrack(t)}clearTrack(t){t.moofs=[],t.mdats=[],t.start=[],t.durations=[],t.duration=0}}class Y{constructor(t){if(t){if("undefined"!=typeof Buffer&&t instanceof Buffer)this.data=new Uint8Array(t);else if(t instanceof Uint8Array==!1)throw new Error("Data error")}else this.data=new Uint8Array(0);this.data=t,this.rootBox=null,this.data?this.parse():this.root=new et("isom")}parse(){const e=new tt(this.data),i=t=>{var s=e.analyze(t);if(s){var r=new et(s,t,e.getPos());if(this.root||(this.root=r),s.container){r.setData(e.copy(8),s.size);for(let t=0,e=s.children;t<e;t++)i(r)}else r.setDataAndSync(e.copy(s.size))}};i(null)}get root(){return this.rootBox}set root(t){this.rootBox=t}size(){if(!this.root)return 0;const i=t=>{let e,s=t.children.length,r=t.size();for(e=0;e<s;e++)r+=i(t.children[e]);return r};return i(this.root)}tree(a,t){if(!this.root)return(a||console.log)("no box found");const o="                                  ",n=(s,r)=>{var e=(s.offset+o).substr(0,10)+"| "+o.substr(0,2*r)+"+"+s.type+" / "+s.size()+(s.container?" ( total "+s.wholeSize+" ) ":"")+(s.id?" , ID:"+s.id:"");if((a||console.log)(e),t)for(const i in s)if(!("function"==typeof s[i]||s[i]instanceof et||et.ignore[i])){let t=s[i];if(s[i]instanceof Array){if(s[i][0]instanceof et)continue;t=JSON.stringify(s[i].slice(0,10)),10<s[i].length&&(t+=" ...")}e="          | "+o.substr(0,2*r)+"  > "+i+" : "+t,(a||console.log)(e)}for(let t=0,e=s.children.length;t<e;t++)n(s.children[t],r+1)};n(this.root,0)}publish(e,s){if(!this.root)throw new Error("no rootbox found");const o=this.size(),n=new tt(new Uint8Array(o)),h=(r,i)=>{let a=r.children.length;r.publish(n,t=>{e(Math.floor(100*t/o))},t=>{const s=e=>{e<a?h(r.children[e],t=>{s(e+1)}):i(null)};s(0)})};h(this.root,t=>{s(t,n.data)})}async publishAsync(){return new Promise((t,e)=>{if(!this.root)return e("no rootbox found");e=this.size();const a=new tt(new Uint8Array(e)),o=(s,r)=>{let i=s.children.length;s.publish(a,null,()=>{const e=t=>{t<i?o(s.children[t],()=>{e(t+1)}):r()};e(0)})};o(this.root,()=>{t(a.data)})})}async clone(){var t=await this.publishAsync();return new Y(t)}static get Box(){return et}}class tt{constructor(t){this.ptr=0,this.data=t}read8(){return this.data[this.ptr++]}read16(){return this.data[this.ptr++]<<8|this.data[this.ptr++]}read24(){return this.data[this.ptr++]<<16|this.data[this.ptr++]<<8|this.data[this.ptr++]}read32(){return this.data[this.ptr++]<<24|this.data[this.ptr++]<<16|this.data[this.ptr++]<<8|this.data[this.ptr++]}read64(){return 4294967296*this.read32()+this.read32()}readText(e){let s="";for(let t=0;t<e;t++){var r=this.data[this.ptr++];s+=String.fromCharCode(r)}return s}readTextAsNullTermination(){var t=this.data.length;let e="";for(;this.ptr<t;){var s=this.data[this.ptr++];if(0===s)break;e+=String.fromCharCode(s)}return e}readUint8Array(e,s,r){for(let t=0;t<r;t++)e[s++]=this.data[this.ptr++]}write8(t){return this.data[this.ptr++]=255&t,this}write16(t){return this.data[this.ptr++]=t>>8&255,this.data[this.ptr++]=255&t,this}write24(t){return this.data[this.ptr++]=t>>16&255,this.data[this.ptr++]=t>>8&255,this.data[this.ptr++]=255&t,this}write32(t){return this.data[this.ptr++]=t>>24&255,this.data[this.ptr++]=t>>16&255,this.data[this.ptr++]=t>>8&255,this.data[this.ptr++]=255&t,this}write64(t){return this.write32(Math.floor(t/4294967296)),this.write32(Math.floor(t%4294967296)),this}writeText(s,r){for(let t=0,e=r=r||s.length;t<e;t++)this.data[this.ptr++]=s.charCodeAt(t);return this}writeTextAsNullTermination(t){return this.writeText(t),this.data[this.ptr++]=0,this}writeUint8Array(e,s,r){if(r<512)for(let t=0;t<r;t++)this.data[this.ptr++]=e[s++];else this.data.set(e.subarray(s,s+r),this.ptr),this.ptr+=r;return this}fill(e,s){s=s||0;for(let t=0;t<e;t++)this.data[this.ptr++]=s;return this}getPos(){return this.ptr}setPos(t){return this.ptr=t,this}skip(t){return this.ptr+=t,this}ready(){return this.ptr<this.data.length}copy(t){var e=this.data.subarray(this.ptr,this.ptr+t);return this.ptr+=t,this.ptr<0?new Uint8Array(e):e}toUint8Array(){return this.data}analyze(t){let s=null,e=this.ptr,r,i;var a=t=>!!t.match(/^[a-zA-Z0-9\u00a9]{4}$/),o=(t?(r=this.read32(),"mdat"===(i=this.readText(4))&&1===r&&(r=this.read32()<<32|this.read32())):(r=this.data.length+8,i="isom",e-=8),e+r);if(o<=this.data.length&&a(i)){s={size:r-(t?0:8),type:i,container:!1,children:0};let e=8;for(;e<r;){let t=this.read32();var n=this.readText(4);if("mdat"===n&&1===t&&(t=this.read32()<<32|this.read32(),this.skip(-8)),!a(n))break;if(t<8)break;this.skip(t-8),e+=t,s.children++}r===e&&(s.container=!0)}return this.ptr=e,s}}class et{constructor(t,e,s){if(!t)throw new Error("Mp4Box Error");if("string"==typeof t){if(this.property=boxSetUp[t],!this.property)throw new Error(t+" type is not supported");this.boxInfo={type:t,container:this.property.container}}else{if(!t.type)throw new Error("Box info type is necessary");this.boxInfo=t,this.property=boxSetUp[t.type]}this.type=this.boxInfo.type,this.container=this.boxInfo.container||this.property&&this.property.container||!1,this.setData(new Uint8Array(0),0),this.offset=null!==s&&0<s?s:0,this.id=null,this.parent=e,this.children=[],c()||this.parent&&this.parent.appendChild(this),this.wholeSize=0}setData(t,e){this.data=t,this.buffer=new tt(t),e&&(this.wholeSize=e)}setDataAndSync(t,e){this.setData(t,e),this.sync(1)}size(){return this.container?"isom"===this.type?0:8:this.wholeSize||this.data&&this.data.length}sync(t){var e=this.property&&this.property.struct||this.boxInfo.struct,s=this.property&&this.property.minLength||this.boxInfo.minLength;if(!e)return 0;if(0!==t&&1!==t&&2!==t)return 0;if(0!==t){if(this.buffer.data.length<8)return 0;this.buffer.setPos(8)}return this.recursiveProc({mode:t,struct:e,minLength:s},this,0)+8}calcLength(e,s,t){var r=typeof e;if(s=0<s?s:1,"number"==r)return e;if("string"!=r)return 0;if("end"==e)return Math.floor((this.size()-this.buffer.getPos())/s);{r=e.match(/(\w+)([\-\+\*\/\d]*)/);let t=this[r[1]]||0;s=r[2]&&r[2][0];return s&&(e=Number(r[2].substr(1)),"-"===s&&(t-=e),"+"===s&&(t+=e),"*"===s&&(t*=e),"/"===s&&(t/=e)),t}}recursiveProc(t,r,i){var{mode:a,struct:s,minLength:o}=t;let n=0;for(let e=0,t=s.length;e<t;e++){var h=s[e][0],d=s[e][1];let t=s[e][2];var l=s[e][3],u=s[e][4];if(null===l||(this.version&&0<this.version&&"or"===l&&(t=u),!this.flags||"if"!==l||0!=(this.flags&u))){if(1===a&&!this.buffer.ready())break;if(2===a&&void 0===r[h])break;if(0===a&&o&&o<=n&&void 0===r[h])break;if("int"===d)1===t?(1===a?r[h]=this.buffer.read8():2===a&&this.buffer.write8(r[h]),n+=1):2===t?(1===a?r[h]=this.buffer.read16():2===a&&this.buffer.write16(r[h]),n+=2):3===t?(1===a?r[h]=this.buffer.read24():2===a&&this.buffer.write24(r[h]),n+=3):4===t?(1===a?r[h]=this.buffer.read32():2===a&&this.buffer.write32(r[h]),n+=4):8===t&&(1===a?r[h]=this.buffer.read64():2===a&&this.buffer.write64(r[h]),n+=8);else if("skip"===d){l=this.calcLength(t,1);1===a?(r[h]="("+l+")bytes",this.buffer.skip(l)):2===a&&this.buffer.fill(l,0),n+=l}else if("text"===d){u=this.calcLength(t,1);0<u?(1===a?r[h]=this.buffer.readText(u):2===a&&this.buffer.writeText(r[h],u),n+=u):(1===a?r[h]=this.buffer.readTextAsNullTermination():2===a&&this.buffer.writeTextAsNullTermination(r[h]),r[h]&&(n+=r[h].length+1))}else if(d instanceof Array&&((1===a||0===a&&void 0===r[h])&&(r[h]=[]),0<d.length)){var m=d[0]instanceof Array;let s=0;if(m)for(let t=0,e=d[0].length;t<e;t++)s+=d[0][t][2];else s=d[1];var f,c=0===a?r[h].length:this.calcLength(t,s);for(let t=0;t<c;t++)m?(f=1===a?{}:r[h][t])&&(n+=this.recursiveProc({mode:a,struct:d,minLength:o},f,i+1),1===a&&r[h].push(f)):n+=this.recursiveProc({mode:a,struct:[[t,d[0],d[1]]],minLength:o},r[h],i+1)}0===i&&r[h]}}return n}hasChild(s){for(let t=0,e=this.children.length;t<e;t++)if(this.children[t]===s)return t;return-1}append(t){return this.appendChild(t)}appendChild(e){if(e){if(-1===this.hasChild(e)){this.children.push(e);let t=this[e.type+"s"];(t=t||[]).push(e),this[e.type+"s"]=t,this[e.type]=t[0]}e.parent=this}}remove(t){return this.removeChild(t)}removeChild(t){var e,s;t&&(-1!==(e=this.hasChild(t))&&(this.children.splice(e,1),(e=this[t.type+"s"])?(0<=(s=e.indexOf(t))&&e.splice(s,1),0<e.length?this[t.type]=e[0]:(delete this[t.type+"s"],delete this[t.type])):delete this[t.type]),t.parent=null)}find(t){const i=s=>{if(s.type===t)return s;for(let t=0,e=s.children.length;t<e;t++){var r=i(s.children[t]);if(r)return r}return null};return i(this)}findAll(t){const i=(s,r)=>{s.type===t&&r.push(s);for(let t=0,e=s.children.length;t<e;t++)i(s.children[t],r);return r};return i(this,[])}arrange(){const i=s=>{var t=s.sync(0)||s.size();"mdat"!==s.type&&t!==s.data.length&&s.setData(new Uint8Array(t)),s.sync(2);let r=s.offset+t;for(let t=0,e=s.children.length;t<e;t++)s.children[t].offset=r,r+=i(s.children[t]);return s.wholeSize=r-s.offset,s.buffer.setPos(0),s.buffer.write32(s.wholeSize),s.buffer.writeText(s.type,4),s.wholeSize};return i(this)}publish(t,e,s){var r=this.sync(0),r=(0<r&&r>this.data.length&&this.setData(new Uint8Array(r)),this.sync(2),this.size());0<r&&t&&t.writeUint8Array(this.data,0,r),s(null)}publishToFile(t,e,s){var r=this.sync(0),r=(0<r&&r>this.data.length&&this.setData(new Uint8Array(r)),this.sync(2),this.size());0<r&&t?t(this.type,(t,e)=>{e||t.write(new Blob([this.data])),s(null)}):s(null)}inspect(){return"Box : '"+this.type+"' [ "+(this.container?"container":"prop")+" ] / "+this.size()}dump(){var t,e="";for(t in this)"function"!=typeof this[t]&&(e+=t+":"+this[t]+" , ");return e}static create(s,t,r){var i={};if(i.type=s,i.struct=t||boxSetUp[s].struct,c()||!(i.struct||r instanceof Uint8Array))return null;var a=new et(i);if(i.struct){a.setData(new Uint8Array(0));for(let t=0,e=i.struct.length;t<e;t++){var o=i.struct[t][0];const s=i.struct[t][1];a[o]=r&&r[o]||(s instanceof Array?[]:"text"===s?"":0)}}else a.setDataAndSync(r);return a}static get ignore(){return{type:1,container:1,data:1,buffer:1,offset:1,id:1,parent:1,children:1,wholeSize:1,boxInfo:1,property:1}}}async function u(e,r,i,a=!1){return new Promise((s,t)=>{try{CHROME.runtime.sendMessage({cmd:"FETCH_DATA",parameter:{url:e,headers:r,method:i}},function(e){if(e.ok&&(e.content=new Uint8Array(e.content),a))return void new Blob([e.content],{type:"text/plain"}).text().then(function(t){e.content=t,s(e)});s(e)})}catch(t){s({ok:!1,message:t.name})}})}function m(t,e,s){let r=s.tracks;for(const l in r=r.audiovideo?function(t){var s=new Y(t.initSegment).root;if(!s.moov)return t;var{container:r,codec:i}=t,a={};for(let t=0,e=s.moov.traks.length;t<e;t++){var o=new Y,n=o.root,n=(s.ftyp&&n.append(s.ftyp),n.append(new Y.Box("moov")),n.moov.append(s.moov.mvhd),n.moov.append(new Y.Box("mvex")),n.moov.mvex.append(s.moov.mvex.trexs[t]),n.moov.append(s.moov.traks[t]),n.arrange(),"vide"===s.moov.traks[t].mdia.hdlr.handlerType?"video":"audio");a[n]={initSegment:o,container:r,codec:i,isMP4:!0}}return a}(r.audiovideo):r)if(l.match(/audio|video/)){var i,a,o,n,h=r[l],d=t.getTrackByType(l);h.initSegment&&(a=(i=h.isMP4?h.initSegment:new Y(h.initSegment)).root&&i.root.moov,i.id=a?`${h.container}:${h.codec}:${a.trak.tkhd.width}:${a.trak.tkhd.height}:`+a.trak.mdia.mdhd.timeScale:`${h.container}:${h.codec}:`+"void",d.init=i);try{"video"===l?(o=d.init.root.moov.trak.tkhd,d.quality=Math.floor(o.width/65536+.4)+" x "+Math.floor(o.height/65536+.4)):(n=d.init.root.moov.trak.mdia.mdhd,d.quality=n.timeScale+" Hz")}catch(t){d.quality=""}}t.setQuality()}function p(e,s,t){var t=t["data1"],r=function(t){var s=t.root;if(s.moov){var e=s.moov.traks.length;if(1<e&&s.moov.mvex.trexs.length===e){var r=[];for(let t=0;t<e;t++){var i=new Y,a=i.root;s.ftyp&&a.append(s.ftyp),a.append(new Y.Box("moov")),a.moov.append(s.moov.mvhd),a.moov.append(new Y.Box("mvex")),a.moov.mvex.append(s.moov.mvex.trexs[t]),a.moov.append(s.moov.traks[t]),a.arrange(),r.push(i)}return r}}else if(s.moof){var o=t.data,n=s.moof.trafs.length;if(1<n){var h=[];for(let t=0;t<n;t++){var d=new Y,l=d.root,u=(s.styp&&l.append(s.styp),s.sidx&&l.append(s.sidx),l.append(new Y.Box("moof")),l.moof.append(s.moof.mfhd),l.moof.append(s.moof.trafs[t]),l.arrange(),l.publish(null,null,()=>{}),h.push(d),[]);let e=0;for(const f of s.moof.trafs[t].truns){var m=s.moof.offset+f.dataOffset;let t=0;for(const c of f.samples)t+=c.size;u.push(o.slice(m,m+t)),e+=t}l=new Uint8Array(8);e+=8,l.set([e>>24&255,e>>16&255,e>>8&255,255&e,109,100,97,116]),d.mdat=new Blob([l,...u]),d.isDivided=!0}return h}}return[t]}(new Y(new Uint8Array(t)));if(1===r.length){var i=r[0];for(let t=0;t<i.root.moofs.length;t++){var a=i.root.moofs[t],o=e.getTrackByNumber(a.traf.tfhd.trackID),n=o.moofs.length;o.moofs[n]=a,o.mdats[n]=new Blob([i.root.mdats[t].data]),o.start[n]=1e9*s.cc+n}for(let t=0;t<e.tracks.length;t++)e.tracks[t].duration+=s.duration}else{var h=s._n;for(const l of r){var d=e.getTrackByNumber(l.root.moof.traf.tfhd.trackID);d.moofs[h]=l.root.moof,d.mdats[h]=l.mdat,d.start[h]=1e9*s.cc+s.sn,d.duration+=s.duration}}e.size+=t?.byteLength||0}function v(t){const r=s=>{"mdat"!==s.type&&(s.data=null,s.buffer=null);for(let t=0,e=s.children.length;t<e;t++)r(s.children[t])};r(t)}function f(e,s,r){var{type:i,data1:a,data2:o}=r;let n=0;if(i.match(/audio|video/)){if("audiovideo"===i)return p(e,s,r);var h=e.getTrackByType(i);let t=h.init;r=s.sn;if(t&&t.id.includes("void")&&o&&MpegAudio.isHeader(o,0)&&(i=MpegAudio.parseHeader(o,0),t=h.init=function(t){var{sampleRate:t,channelCount:e}=t,s=new Y,r=s.root,i=(r.append(new Y.Box("moov")),Y.Box.create("mvhd",null,{timeScale:t,duration:0,rate:65536,volume:256,matrix:[65536,0,0,0,65536,0,0,0,1073741824],preDefined:24,nextTrackID:0})),i=(r.moov.append(i),r.moov.append(new Y.Box("trak")),r.moov.trak),a=Y.Box.create("tkhd",null,{flags:3,trackID:1,duration:0,layer:0,alternateGroup:1,volume:256,matrix:[65536,0,0,0,65536,0,0,0,1073741824]}),a=(i.append(a),i.append(new Y.Box("mdia")),Y.Box.create("mdhd",null,{timeScale:t,duration:5120,languageValues:21956})),a=(i.mdia.append(a),Y.Box.create("hdlr",null,{handlerType:"soun",name:"SoundHandler"})),a=(i.mdia.append(a),i.mdia.append(new Y.Box("minf")),i.mdia.minf.append(Y.Box.create("smhd")),i.mdia.minf.append(new Y.Box("dinf")),i.mdia.minf.dinf.append(Y.Box.create("dref",null,{entryCount:1,entrySize:12,typeText:"url ",entryVersion:0,entryFlags:1})),i.mdia.minf.append(new Y.Box("stbl")),Y.Box.create("stsd",[["version","int",1],["flags","int",3],["entryCount","int",4],["entrySize","int",4],["code","text",4],["reserved","int",3],["reserved2","int",3],["dataReferenceIndex","int",2],["reserved3","int",8],["channelCount","int",2],["sampleSize","int",2],["reserved4","int",4],["sampleRate","int",2],["reserved5","int",2]],{entryCount:1,entrySize:36,code:".mp3",dataReferenceIndex:1,channelCount:e,sampleSize:16,sampleRate:t}));return i.mdia.minf.stbl.append(a),r.moov.append(new Y.Box("mvex")),r.moov.mvex.append(Y.Box.create("trex",null,{sampleDescriptionIndex:1,sampleFlags:65537})),s.id="audio/mp3:"+r.moov.trak.mdia.mdhd.timeScale,r.arrange(),s}(i)),a&&!o){var d=new Y(new Uint8Array(a));for(let t=0;t<d.root.moofs.length;t++){var l=h.moofs.length,u=d.root.moofs[t],m=u.offset,f=m+u.wholeSize;v(u),h.moofs[l]=u,h.mdats[l]=new Blob([d.root.mdats[t].data]),h.start[l]=1e9*s.cc+s.sn,n+=f-m+h.mdats[l].size}}else if(t&&t.id.includes("mp3")){if(!o)return;var{moof:i,mdat:c}=function(e){var s=[],r=e.length;for(let t=0;t<r;){var i=MpegAudio.parseHeader(e,t);if(!i)break;var a=i.frameLength;s.push({duration:i.samplesPerFrame,size:a}),t+=a}var t=new Y,o=(t.root.append(new Y.Box("moof")),t.root.moof.append(new Y.Box("traf")),t.root.moof.traf.append(Y.Box.create("tfhd",[["version","int",1],["flags","int",3],["trackID","int",4],["defaultSampleFlags","int",4,"if",32]],{flags:32,defaultSampleFlags:65536})),t.root.moof.traf.append(Y.Box.create("tfdt",null,{})),Y.Box.create("trun",null,{flags:768,sampleCount:s.length,samples:s})),o=(t.root.moof.traf.append(o),t.root.arrange(),new Uint8Array(8)),n=r+8,n=(o.set([n>>24&255,n>>16&255,n>>8&255,255&n,109,100,97,116]),new Blob([o,e]));return{moof:t,mdat:n}}(o);h.moofs[r]=i,h.mdats[r]=c,h.start[r]=1e9*s.cc+s.sn,n=o.byteLength}else{if(!a||!o)return;i=new Y(new Uint8Array(a));v(i.rootBox),h.moofs[r]=i,h.mdats[r]=new Blob([o]),h.start[r]=1e9*s.cc+s.sn,n=a.byteLength+o.byteLength}h.duration+=s.duration,e.size+=n}}async function st(t){return new Promise((e,s)=>{const r=new FileReader;r.onload=t=>{e(r.result)},r.onerror=t=>{s(r.error)},r.readAsArrayBuffer(t)})}async function rt(s){return new Promise((t,e)=>{setTimeout(t,s)})}function c(){try{return d!==_byl?1:void 0}catch(t){return 1}}async function a(g,t){if(!g||0===g.length)throw new Error("Video is empty");let e=0;for(let t=0;t<g.length;t++)g[t].mimetype.includes("video")&&(e=t);2===g.length&&1===e&&(g=[g[1],g[0]],e=0);var{keyFrameComplement:y,modifyESDSTrackConfig:v,over4G:w}=t,i=[];for(let r=0,t=g.length;r<t;r++){var a=g[r];let s=0;for(let t=0,e=a.mdats.length;t<e;t++)void 0!==a.start[t]&&(i.push({track:r,num:t,order:s,start:a.start[t]}),s++)}i.sort((t,e)=>t.start-e.start);for(const m of g)m.mdats[0]&&9===m.mdats[0].size&&(m.mdats=[]);var s=[];const x=[];for(const f of g){let t;t=f.init&&f.init.data?f.init.data.length<2e4?new Y(f.init.data.slice()):f.init:await f.init.clone(),s.push(t),x.push(t.root)}for(let t=0,e=x.length;t<e;t++){var r=x[t],o=(r.moov.mvhd.version=r.moov.trak.tkhd.version=r.moov.trak.mdia.mdhd.version=0,r.moov.trak.tkhd.flags=3,t+1);if(r.moov.trak.tkhd.trackID=r.moov.mvex.trex.trackID=o,r.ftyp&&(r.ftyp.majorBrand="mp42",r.ftyp.minorVersion=0,r.ftyp.compatibleBrands=["isom","iso2","avc1","mp41","mp42"]),v){var o=r.moov.trak.mdia.minf.stbl.stsd,n=new tt(o.data),R=(n.skip(12),n.read32());for(let t=0;t<R;t++){var N=n.read32();if("mp4a"===n.readText(4)){n.skip(28);var F=n.getPos(),h=n.read32();if("esds"===n.readText(4)){n.skip(5);var O=n.read8(),q=(n.skip(4),n.read8()),G=(n.skip(14),n.read8());if(4===G){var H=n.read8(),j=n.read8(),Q=(n.skip(2),[]);for(let t=0,e=h-38;t<e;t++)Q.push(n.read8());n.setPos(F),n.write32(h),n.skip(9),n.write8(O-2),n.skip(4),n.write8(q-2),n.skip(14),n.write8(G-2),n.write8(16+(7&H)),n.write8(248&j);for(const W of Q)n.write8(W);n.write16(0)}}else n.skip(h-8)}else n.skip(N-8)}}}var t=new Y,d=t.root;d.append(x[e].ftyp),d.append(new Y.Box("moov")),d.moov.append(x[e].moov.mvhd);for(const Z of x)d.moov.append(Z.moov.trak);d.moov.mvhd.nextTrackID=s.length+1;for(let t=d.moov.mvhd.creationTime=d.moov.mvhd.modificationTime=0,e=s.length;t<e;t++)d.moov.traks[t].tkhd.creationTime=d.moov.traks[t].mdia.mdhd.creationTime=d.moov.traks[t].tkhd.modificationTime=d.moov.traks[t].mdia.mdhd.modificationTime=0;var l=await(async(t,e)=>{var s=[{type:"vide",length:0,moofs:[],hasBaseMediaDecodeTime:!1},{type:"soun",length:0,moofs:[],hasBaseMediaDecodeTime:!1}];for(const i of s)for(const l of t)l.mdia.hdlr.handlerType===i.type&&Object.assign(i,{trackID:l.tkhd.trackID,timeScale:l.mdia.mdhd.timeScale,length:e[l.tkhd.trackID-1].moofs.length});var r=Math.max(s[0].length,s[1].length);for(let i=0;i<r;i++)for(let r=0;r<2;r++){var a=s[r],o=e[a.trackID-1]?.moofs[i];if(o){var n,h=(o instanceof Y?o:o instanceof et?{root:{moof:o}}:new Y(new Uint8Array(await st(o)))).root.moof.traf,o=h.tfdt.baseMediaDecodeTime<-2147483648?0:h.tfdt.baseMediaDecodeTime,o=(o+=(4294967295&o)<0?4294967296:0)/a.timeScale;let t=!1,e=(0<i&&(a.moofs[i-1].empty||({baseMediaDecodeTime:d,duration:n}=a.moofs[i-1],o<d||d+2*n<o))&&(t=!0),0),s=0;for(const u of h.truns){u.samples=u.samples||new Array(u.sampleCount||0).fill({});for(const m of u.samples||[])e+=m.duration||h.tfhd?.defaultSampleDuration||x[r].moov?.mvex?.trex?.sampleDuration||0,33554432&m.flags&&s++}e/=a.timeScale;var d=(h.trun?.samples?.[0]?.compositionTimeOffset||0)/a.timeScale;a.moofs[i]={baseMediaDecodeTime:o,compositionTimeOffset:d,duration:e,keyFrames:s,discontig:t},0<o&&(a.hasBaseMediaDecodeTime=!0)}else a.moofs[i]={empty:!0,baseMediaDecodeTime:0,duration:0}}return s})(d.moov.traks,g),V=function(s){var r=[[],[]];if(!(1<s[0].length&&!s[0].hasBaseMediaDecodeTime||1<s[1].length&&!s[1].hasBaseMediaDecodeTime)){var i=[0,0],a=[0,0];for(let t=s[0].elstPadding=s[1].elstPadding=0,e=Math.max(s[0].length,s[1].length);t<e;t++){var o,n,h,d=s[0].moofs[t],l=s[1].moofs[t];d&&l&&(d.empty&&(d.baseMediaDecodeTime=a[0]-i[0],s[d.duration=0].moofs[t+1]&&!s[0].moofs[t+1].empty&&(s[0].moofs[t+1].discontig=!0)),l.empty&&(l.baseMediaDecodeTime=a[1]-i[1],l.duration=0,s[1].moofs[t+1]&&!s[1].moofs[t+1].empty&&(s[1].moofs[t+1].discontig=!0)),0===t?(o=0<(n=d.baseMediaDecodeTime-l.baseMediaDecodeTime)?0:1,.01<(n=Math.abs(n))&&(h=s[o].moofs?.[0]?.compositionTimeOffset||0,r[o].push({segmentDuration:Math.floor(1e3*(n+h)),mediaTime:-1,mediaRateInteger:1,mediaRateFraction:0})),s[o].elstPadding=n,i[0]=i[1]=-Math.min(l.baseMediaDecodeTime,d.baseMediaDecodeTime)):d.discontig&&l.discontig?0<=(h=d.baseMediaDecodeTime-l.baseMediaDecodeTime-(a[0]-a[1]))?(i[0]=a[0]+h-d.baseMediaDecodeTime,i[1]=a[1]-l.baseMediaDecodeTime):(i[0]=a[0]-d.baseMediaDecodeTime,i[1]=a[1]-h-l.baseMediaDecodeTime):d.discontig?i[0]=a[0]-d.baseMediaDecodeTime:l.discontig&&(i[1]=a[1]-l.baseMediaDecodeTime),d.baseMediaDecodeTime+=i[0],l.baseMediaDecodeTime+=i[1],a[0]=d.baseMediaDecodeTime+d.duration,a[1]=l.baseMediaDecodeTime+l.duration)}for(let t=0;t<2;t++){var e=s[t],u=Math.floor(1e3*(a[t]-e.elstPadding))||123456789,m=e.moofs?.[0]?.compositionTimeOffset||0,m=Math.floor(m*e.timeScale)||0;r[t].push({segmentDuration:u,mediaTime:m,mediaRateInteger:1,mediaRateFraction:0})}}return r}(l);let $=[{},{}];try{localStorage.nosync||($=await function(s){var r=[{},{}];if(1<s[0].length&&!s[0].hasBaseMediaDecodeTime||1<s[1].length&&!s[1].hasBaseMediaDecodeTime)return r;var i=[0,0];let t=!1;s[0].duration=s[1].duration=0,s[0].original_duration=s[1].original_duration=0;var a,o,n=Math.max(s[0].length,s[1].length);for(let e=0;e<n;e++){for(let t=0;t<2;t++)s[t].moofs[e].empty||(e<n-2-1&&((a=s[t].duration-(s[t].moofs[e].baseMediaDecodeTime-s[t].elstPadding+0))<-.05?(i[t]++,2<=i[t]&&(r[t][e+1]=Math.floor(a*s[t].timeScale),s[t].duration-=a,i[t]=0)):i[t]=0),s[t].original_duration+=s[t].moofs[e].duration,s[t].duration+=s[t].moofs[e].duration);e===n-2-2&&(o=s[0].original_duration-s[1].original_duration,Math.abs(o)<.1&&(t=!0))}return t?[{},{}]:r}(l))}catch(t){console.log(t.stack||t.message||t)}let b=0;for(const _ of d.moov.traks){var k=_.mdia.minf.stbl,S=_.tkhd.trackID,T=_.mdia.hdlr.handlerType;"soun"===T&&(_.tkhd.alternateGroup=1,_.tkhd.volume=256);let{stsz:n,stts:s,stsc:r,stss:i,stco:t,ctts:a,sdtp:o,co64:e}=k,h=(n||k.append(n=Y.Box.create("stsz")),s||k.append(s=Y.Box.create("stts")),r||k.append(r=Y.Box.create("stsc")),i||k.append(i=Y.Box.create("stss")),o=o||Y.Box.create("sdtp"),a=a||Y.Box.create("ctts"),w?(e||k.append(e=Y.Box.create("co64")),t&&(k.remove(t),t=null)):(t||k.append(t=Y.Box.create("stco")),e&&(k.remove(e),e=null)),n.sampleSizes=[],s.entries=[],r.entries=[],i.syncSamples=[],o.sampleDependencies=[],a.entries=[],0),d=0,l=0,u=0,m=0,f=-1,c=0,p=0;var I=[];let v=0;for(const E of g[S-1].moofs)if(E){var D=E instanceof Y?E:E instanceof et?{root:{moof:E}}:new Y(new Uint8Array(await st(E))),J=D.root.moof,z=(D.root.mdat&&g[S-1].mdats.push(new Blob([D.root.mdat.data])),J.traf),M=z.tfhd,U=x[S-1].moov.mvex&&x[S-1].moov.mvex.trex;d++;let t=0,e=0;p+=$[S-1][d]||0;for(const L of z.truns){L.samples=L.samples||new Array(L.sampleCount||0).fill({});for(const X of L.samples){var A,B=Object.assign({},X);h++,B.duration=B.duration||M&&M.defaultSampleDuration||U&&U.sampleDuration||0,B.size=B.size||M&&M.defaultSampleSize||U&&U.sampleSize||0,B.flags=B.flags||M&&M.defaultSampleFlags||U&&U.sampleFlags||0,0!==(p=Math.floor(p))&&("vide"===T?(A=0<p?Math.min(B.duration-1,p):p,B.duration-=A,p-=A):"soun"===T&&p<0&&B.duration<-p&&(t++,m++,v+=B.duration,n.sampleSizes.push(0),p+=B.duration)),y&&0===e&&I.push(h),e++,0<(33554432&B.flags)&&"soun"!==T&&i.syncSamples.push(h),n.sampleSizes.push(B.size),u!==B.duration&&(0<m&&(s.entries.push({sampleCount:m,sampleDuration:u}),m=0),u=B.duration),m++,v+=B.duration,0<(2048&L.flags)&&(f!==B.compositionTimeOffset&&0<c&&(a.entries.push({sampleCount:c,sampleOffset:f}),c=0),f=B.compositionTimeOffset,c++)}t+=L.sampleCount,z.sdtp&&o.sampleDependencies.push(...z.sdtp.sampleDependencies)}l!==t&&(l=t,r.entries.push({firstChunk:d,samplesPerChunk:l,sampleDescriptionIndex:1})),d%100==0&&await rt(1)}s.entries.push({sampleCount:m,sampleDuration:u}),-1!==f&&a.entries.push({sampleCount:c,sampleOffset:f}),"vide"===T&&i.syncSamples.length<1+Math.floor(.8*d)&&((C=function(){var s=[];let t=0;for(const a of n.sampleSizes)t+=a;var r=t/n.sampleSizes.length;t=0;for(const o of n.sampleSizes){var e=o-r;t+=e*e}var i=Math.sqrt(t/n.sampleSizes.length);for(let t=0,e=n.sampleSizes.length;t<e;t++)3<(n.sampleSizes[t]-r)/i&&s.push(t+1);return s}()).length>i.syncSamples.length?i.syncSamples=C:y&&I.length>i.syncSamples.length&&(i.syncSamples=I),0===i.syncSamples.length&&(i.syncSamples=[1])),n.sampleCount=n.sampleSizes.length,s.entryCount=s.entries.length,r.entryCount=r.entries.length,i.entryCount=i.syncSamples.length,w?(e.entryCount=d,e.chunkOffsets=new Array(d)):(t.entryCount=d,t.chunkOffsets=new Array(d)),a.entries.length&&(a.entryCount=a.entries.length,"soun"!==T&&k.append(a)),_.mdia.mdhd.duration=v,_.tkhd.duration=Math.floor(v/_.mdia.mdhd.timeScale*1e3),_.edts||_.append(new Y.Box("edts")),_.edts.elst||_.edts.append(Y.Box.create("elst"));var C=0<a.entryCount?a.entries[0].sampleOffset:0,P=V[S-1]||[];0<P.length?(_.edts.elst.entryCount=P.length,_.edts.elst.entries=P):(_.edts.elst.entryCount=1,_.edts.elst.entries=[{segmentDuration:_.tkhd.duration,mediaTime:C,mediaRateInteger:1,mediaRateFraction:0}]),o.sampleDependencies.length&&k.append(o),_.mdia.mdhd.duration=v,b=Math.max(v/_.mdia.mdhd.timeScale,b)}l=Math.floor(1e3*b);d.moov.mvhd.timeScale=1e3,d.moov.mvhd.duration=l,d.arrange();let u=t.size();for(const c of i)w?d.moov.traks[c.track].mdia.minf.stbl.co64.chunkOffsets[c.order]=u+8:d.moov.traks[c.track].mdia.minf.stbl.stco.chunkOffsets[c.order]=u+8,u+=g[c.track].mdats[c.num].size;var K=[new Blob([await t.publishAsync()])];for(const p of i)K.push(g[p.track].mdats[p.num]);return new Blob(K,{type:"appplication/octet-stream"})}async function g(t){var e=(t.isLive&&t.hasAltAudio?function(r){let t=0;for(const m of r){var e=m.start.length;0<e&&m.start[e-1]>t&&(t=m.start[e-1])}let i=t;for(const f of r)0<f.start.length&&f.start[0]<i&&(i=f.start[0]);var a=[];for(const c of r){var{mimetype:s,init:o}=c;a.push({mimetype:s,init:o,moofs:[],mdats:[],start:[]})}for(let s=i;s<=t;s++){var n=[];for(let t=0,e=r.length;t<e;t++){var h=r[t].start.indexOf(s);-1!==h&&n.push(h)}if(n.length===r.length)for(let t=0,e=r.length;t<e;t++){var d=r[t],l=n[t],u=a[t];u.moofs.push(d.moofs[l]),u.mdats.push(d.mdats[l]),u.start.push(d.start[l])}}return a}:function(t){var e=[];for(const n of t){var s,r,i,a,o;n.init&&0<n.moofs.length&&(s=n.moofs.slice(0),r=n.mdats.slice(0),i=n.start.slice(0),{mimetype:a,init:o}=n,e.push({mimetype:a,init:o,moofs:s,mdats:r,start:i}))}return e})(t.tracks),{size:t,sourceType:s}=t;if(0===e.length||0===e[0].moofs.length)return null;var r={};r.keyFrameComplement=4===s,r.modifyESDSTrackConfig=4===s,r.over4G=4e9<t;let i;try{i=await a(e,r)}catch(t){return null}return URL.createObjectURL(i)}Object.assign(t,{Manifest:class{constructor(t,e){this.id=Math.floor(1e8*Math.random()),this.name=t.filename,this.headers=t.headers,this.url=t.url,this.method=t.method,this.downloadUI=e,this.index=0,this.master=[],this.status="normal",this.requestError=0,this.size=0,this.cached=0,this.speeder=null,this.sizePrev=0,this.total=0,this.threads=0,this.threadsLimit=4,this.divide={threshold:5368709120,partSize:0,currentPart:0},this.hasQuality=!1,this.isMaster=!0,this.timeSpent=3}async parseDivide(){if(this.total&&this.cached&&this.divide.partSize&&"pause"!==this.status&&"completed"!==this.status&&"error"!==this.status&&"cancel"!==this.status){var s=this.cached/this.total,r=Math.round(this.size/s);let t=1,e=r/t;for(;e>this.divide.threshold;)t++,e=r/t;e=Math.round(e),this.divide.partSize>=e&&1<t&&t!==this.divide.currentPart+1&&(this.status="pause",this.divide.partSize=0,this.divide.currentPart++,await this.completed(),this.start())}}start(){"pause"===this.status&&(this.status="normal"),this.sizePrev=0,this.requestError=0;this.speeder||(this.speeder=setInterval(function(e){if("pause"===e.status||"error"===e.status||"cancel"===e.status||"completed"===e.status)clearInterval(e.speeder),e.speeder=null,e.downloadUI.setSpeed(0),e.downloadUI.setThreads(0);else{let t=0;e.sizePrev&&(t=e.sizePrev/3,t=Math.round(t)),e.downloadUI.setTimeSpent(e.timeSpent),e.downloadUI.setSpeed(t),e.sizePrev=0,e.timeSpent=e.timeSpent+3}},3e3,this)),this.fetch(),this.downloadUI.start(),this.downloadUI.setErrorRequest(0)}pause(){this.status="pause",this.downloadUI.pause(0<this.divide.partSize)}cancel(){this.status="cancel";var t=this.master[this.index];if(t.video&&t.video.clearAllTracks(),t.details)for(var e of t.details.fragments)e.data&&(e.data=null);this.downloadUI.cancel()}async savePart(){var t=await this.flush(!1);this.downloadUI.savePart(t,this.name)}async completed(e=!1){e&&(this.status="completed");var s=await this.flush();if(s){var r=this.divide.currentPart;let t=this.name;r&&(t=t+"-part"+r),this.master[this.index].video.preview||(this.downloadUI.setPreview(s),this.master[this.index].video.preview=s),this.downloadUI.completed(s,t,r,e)}}async loadMaster(){var s=this.url,t=await u(s,{},this.method,!0);if(t.ok){var r=(r=M3U8Parser.parseMasterPlaylist(t.content,s)).levels;if(d=btoa(encodeURI(location.host)).toLowerCase().replace(/=/g,""),r.length<1){this.isMaster=!1;var e,i=M3U8Parser.parseLevelPlaylist(t.content,s,0,"main",1);for(e in i.fragments)i.fragments[e].status="pending";s={attrs:{},audioCodec:null,videoCodec:null,bitrate:0,width:0,height:0,url:s,details:i};r.push(s),this.master=r,this.total=i.fragments.length,s=this.master[this.index],await this.loadInitSegment(s),s.video=new l(this);const h={name:this.name,total:s.details.fragments.length};this.downloadUI.loadIndexSuccess(h,null,!1),this.downloadUI.createThreadsControls(this.threadsLimit),void this.start()}else{let t=0,e=0;for(var a in r){var o=r[a].attrs.BANDWIDTH;o&&(o=parseInt(o))>t&&(e=a,t=o)}this.master=r;var s=this.master[e],n=(await this.loadLevel(s,e),this.getResolution());const h={name:this.name,total:s.details.fragments.length};this.downloadUI.loadIndexSuccess(h,n),this.downloadUI.createThreadsControls(this.threadsLimit),this.start()}}else this.downloadUI.loadIndexError(t.message)}getResolution(){var e,s=[],r=this.master;for(e in r){var i=r[e],a={selected:!1,name:"Resolution-"+e,index:e};e===this.index&&(a.selected=!0);let t="";i.height&&i.width&&(t=i.width+"x"+i.height),(t=i.name?t?t+"-"+i.name:i.name:t)&&(a.name=t),s.push(a)}return s}async loadLevel(t,e){if(t.details){const i=t.details;this.index=e,this.total=i.fragments.length}else{if(!t.url)return this.downloadUI.loadIndexError("503: No level url"),!1;var s,r=await u(t.url,this.headers,this.method,!0);if(!r.ok)return this.downloadUI.loadIndexError(r.message),!1;const i=M3U8Parser.parseLevelPlaylist(r.content,t.url,0,"main",1);for(s in i.fragments)i.fragments[s].status="pending";if(t.details=i,!await this.loadInitSegment(t))return!1;this.index=e,this.total=i.fragments.length}return t.video=new l(this),!0}async loadInitSegment(s){s=s.details;if(!s)return this.downloadUI.loadIndexError("504: Level details is empty"),!1;if(c())s.initSegment={data:null};else{if(s.initSegment){var r=s.initSegment;if(!r.url)return!0;if(r.data)return!0;if(r.decryptdata&&null!=r.decryptdata.uri&&null==r.decryptdata.key)return this.downloadUI.loadIndexError("505: Stream is encrypt"),!1;r=await u(r.url,this.headers,this.method);if(!r.ok)return this.downloadUI.loadIndexError("506: Get init segment failed ("+r.message+")"),!1;s.initSegment.data=r.content}else s.initSegment={data:null};let t=0,e=-1;for(const i of s.fragments)e!==i.cc&&(e=i.cc,t=0),i._n=t,t++}return!0}async switchLevel(e){if((e=parseInt(e))!==this.index){let t=this.master[this.index];var s;!t||(s=t.details.fragments)&&(s.forEach((t,e)=>{t.status="pending",t.data&&(t.data=null)}),t.video=null),(t=this.master[e])&&(this.status="pause",this.downloadUI.setSpeed(0),this.downloadUI.loadingIndex(),await this.loadLevel(t,e)&&(this.status="normal",this.requestError=0,this.size=0,this.sizePrev=0,this.total=t.details.fragments.length,this.cached=0,this.threads=0,this.divide.partSize=0,this.divide.currentPart=0,this.hasQuality=!1,this.speeder&&(clearInterval(this.speeder),this.speeder=null),s={name:this.name,total:this.total},this.downloadUI.loadIndexSuccess(s,null),this.start()))}}freeThreads(){this.threads--,this.threads<0&&(this.threads=0)}async fetch(){if(!(this.threads>=this.threadsLimit))if(this.threads++,this.downloadUI.setThreads(this.threads),"pause"===this.status||"error"===this.status||"cancel"===this.status||"completed"===this.status)this.freeThreads(),this.downloadUI.setThreads(this.threads);else if(29<this.requestError)this.status="pause",this.freeThreads(),t=0<this.size,this.downloadUI.pause(t,!0);else{this.fetch();var{details:t,video:e}=this.master[this.index];for(const i of t.fragments)if("pending"===i.status){i.status="running";var s=await u(URLToolkit.buildAbsoluteURL(i.baseurl,i.relurl),this.headers,this.method);if(!s.ok)return this.requestError++,this.freeThreads(),i.status="pending",this.fetch(),void this.downloadUI.setErrorRequest(this.requestError);if(!e||"cancel"===this.status)return void this.freeThreads();i.status="completed";var r=s.content.byteLength||s.content.length;return i.data=s.content,s.content=null,this.sizePrev=this.sizePrev+r,this.size=this.size+r,this.divide.partSize=this.divide.partSize+r,this.cached++,e.flush(),this.downloadUI.setProgress(this.size,this.cached,this.total),this.parseDivide(),this.freeThreads(),void this.fetch()}this.freeThreads(),"pause"!==this.status&&"error"!==this.status&&"cancel"!==this.status&&"completed"!==this.status&&(c()||this.divide.currentPart&&this.divide.currentPart++,this.completed(!0))}}async flush(t=!0){if("error"===this.status)return null;for(;0<this.threads;)await rt(1e3);await rt(200),this.downloadUI.loadingDivide();var e,s=this.master[this.index],r=s.details.fragments,i=s.video;for(e in r){var a=r[e];a.data&&"completed"===a.status&&await i.push(a)}s=await g(i);return s?(t&&i.clearAllTracks(),i.blobURL=s):(this.status="error",this.downloadUI.error("500: Video flush error"),null)}}})})(this);